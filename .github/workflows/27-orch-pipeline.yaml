name: Deploy Orchestrator

run-name: 'Triggered by ${{ github.actor }} | Org: ${{ inputs.organization }} | Env: ${{ inputs.environment }} | Size: ${{ inputs.size }}'

on:
  workflow_dispatch:
    inputs:
      organization:
        description: 'Select Organization'
        required: true
        default: 'acme-corp'
        type: choice
        options:
          - acme-corp
          - tech-solutions
          - global-enterprises
          - innovation-labs
          - future-systems
      environment:
        description: 'Select Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - stage
          - prod
      size:
        description: 'Select Deployment Size'
        required: true
        default: 'm'
        type: choice
        options: ["m", "l", "xl"]

      run_python:
        description: 'Run automated tests'
        required: false
        default: false
        type: boolean

jobs:
  terraform-deploy:
    uses: ./.github/workflows/reusable_terraform.yaml
    with:
      organization: ${{ inputs.organization }}
      environment: ${{ inputs.environment }}
      size: ${{ inputs.size }}
    secrets: inherit

  ansible-configuration:
    uses: ./.github/workflows/reusable_ansible.yaml
    needs: terraform-deploy
    with:
      organization: ${{ inputs.organization }}
      environment: ${{ inputs.environment }}
      size: ${{ inputs.size }}
    secrets: inherit

  db_patching:
    uses: ./.github/workflows/reusable_db_migration.yaml
    needs: ansible-configuration
    if: ${{ inputs.run_python == true }}
    with:
      organization: ${{ inputs.organization }}
      environment: ${{ inputs.environment }}
      size: ${{ inputs.size }}
    secrets: inherit